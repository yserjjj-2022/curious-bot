# -*- coding: utf-8 -*-

import os
import time
from services.storage_service import StorageService

def run_test():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è StorageService.
    """
    print("=== –ó–ê–ü–£–°–ö –¢–ï–°–¢–ê –î–õ–Ø STORAGE_SERVICE ===")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é –ë–î, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å —Ä–∞–±–æ—á—É—é
    test_db_path = 'data/test_articles.db'
    db_url = f'sqlite:///{test_db_path}'
    
    # --- –®–∞–≥ 0: –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º ---
    if os.path.exists(test_db_path):
        os.remove(test_db_path)
        print(f"–£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î: {test_db_path}")

    # --- –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    print("\n[–¢–ï–°–¢ 1] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞...")
    try:
        storage = StorageService(db_url=db_url)
        if os.path.exists(test_db_path):
            print("‚úÖ –£–°–ü–ï–•: –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.")
        else:
            print("‚ùå –ü–†–û–í–ê–õ: –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω.")
            return
    except Exception as e:
        print(f"‚ùå –ü–†–û–í–ê–õ: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞: {e}")
        return

    # --- –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–π —Å—Ç–∞—Ç—å–∏ ---
    print("\n[–¢–ï–°–¢ 2] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç–∞—Ç—å–∏...")
    article_1_meta = {
        'id': 'W12345', 'display_name': 'First Test Article', 'publication_year': 2025,
        'type': 'article', 'language': 'en'
    }
    summary_1 = "Summary for the first article."
    
    is_added_1 = storage.add_article(article_1_meta, summary_1)
    if is_added_1:
        print("‚úÖ –£–°–ü–ï–•: –ü–µ—Ä–≤–∞—è —Å—Ç–∞—Ç—å—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª True).")
    else:
        print("‚ùå –ü–†–û–í–ê–õ: –ú–µ—Ç–æ–¥ add_article –≤–µ—Ä–Ω—É–ª False –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π —Å—Ç–∞—Ç—å–∏.")
        return
        
    # --- –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ ---
    print("\n[–¢–ï–°–¢ 3] –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–π –∂–µ —Å—Ç–∞—Ç—å–∏...")
    is_added_again = storage.add_article(article_1_meta, summary_1)
    if not is_added_again:
        print("‚úÖ –£–°–ü–ï–•: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ (–º–µ—Ç–æ–¥ –≤–µ—Ä–Ω—É–ª False).")
    else:
        print("‚ùå –ü–†–û–í–ê–õ: –°–µ—Ä–≤–∏—Å –ø–æ–∑–≤–æ–ª–∏–ª –¥–æ–±–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç —Å—Ç–∞—Ç—å–∏.")
        return

    # --- –®–∞–≥ 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–π —Å—Ç–∞—Ç—å–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ ---
    print("\n[–¢–ï–°–¢ 4] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–π —Å—Ç–∞—Ç—å–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞...")
    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ—Ç–ª–∏—á–∞–ª–∏—Å—å
    time.sleep(1) 
    
    article_2_meta = {
        'id': 'W67890', 'display_name': 'Second Test Article', 'publication_year': 2024,
        'type': 'report', 'language': 'en'
    }
    summary_2 = "Summary for the second article."
    storage.add_article(article_2_meta, summary_2)
    
    latest_articles = storage.get_latest_articles(limit=5)
    
    if len(latest_articles) == 2:
        print("‚úÖ –£–°–ü–ï–•: –ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π (2).")
    else:
        print(f"‚ùå –ü–†–û–í–ê–õ: –ü–æ–ª—É—á–µ–Ω–æ {len(latest_articles)} —Å—Ç–∞—Ç–µ–π, –æ–∂–∏–¥–∞–ª–æ—Å—å 2.")
        return
        
    if latest_articles[0]['id'] == 'W67890':
        print("‚úÖ –£–°–ü–ï–•: –°—Ç–∞—Ç—å–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–≤—Ç–æ—Ä–∞—è —Å—Ç–∞—Ç—å—è –∏–¥–µ—Ç –ø–µ—Ä–≤–æ–π).")
    else:
        print("‚ùå –ü–†–û–í–ê–õ: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å—Ç–∞—Ç–µ–π.")
        print("   –û–∂–∏–¥–∞–ª–æ—Å—å, —á—Ç–æ –ø–µ—Ä–≤–æ–π –±—É–¥–µ—Ç W67890, –Ω–æ –ø–æ–ª—É—á–µ–Ω–æ:", latest_articles[0]['id'])
        return

    print("\nüéâüéâüéâ –í—Å–µ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã! StorageService —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. üéâüéâüéâ")

if __name__ == "__main__":
    run_test()

